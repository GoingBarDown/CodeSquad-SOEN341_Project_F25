<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Profile | CampusConnect</title>

    <script>
      (function () {
        // helper to read a cookie value
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(";").shift();
          return null;
        }

        // Accept any of these as proof-of-login: explicit userData, cookie userId, or localStorage keys
        const userData = localStorage.getItem("userData");
        const cookieUserId = getCookie("userId");
        const lsUserId = localStorage.getItem("userId");
        const loggedInUser = localStorage.getItem("loggedInUser");

        if (!userData && !cookieUserId && !lsUserId && !loggedInUser) {
          alert("❌ Please login first");
          window.location.href = "login.html";
          return;
        }

        if (userData) {
          try {
            const user = JSON.parse(userData);
            if (user.role && user.role !== "student") {
              alert("❌ You do not have permission to access this page.");
              window.location.href = "index.html";
              return;
            }
          } catch (e) {
            console.error("Error parsing userData on profile page:", e);
            // fall through — if other keys exist we still allow
          }
        }
      })();
    </script>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="editProfilePage.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&display=swap"
      rel="stylesheet"
    />
  </head>

  <body class="student-profile-page">
    <!-- Header -->
    <header>
      <div id="logo">CODESQUAD EDIT PROFILE</div>
      <button id="dot">&#8801;</button>
    </header>

    <!-- Menu -->
    <div id="menu">
      <nav id="student-menu">
        <a href="index.html">Home</a>
        <a href="events.html">Events</a>
        <a href="profilePage.html">Profile</a>
        <a href="my_tickets.html">My Tickets</a>
        <a href="student_calender.html">Calendar</a>
        <a href="#" id="logout-btn-student">Log Out</a>
      </nav>
    </div>

    <!-- Profile Card -->
    <main class="centered">
      <div class="card">
        <h2>Profile</h2>

        <form id="studentProfileForm">
          <label for="firstName">First Name</label>
          <input
            type="text"
            id="firstName"
            name="first_name"
            minlength="2"
            maxlength="80"
          />

          <label for="lastName">Last Name</label>
          <input
            type="text"
            id="lastName"
            name="last_name"
            minlength="2"
            maxlength="80"
          />

          <label for="email">Email</label>
          <input type="email" id="email" readonly />
          <small class="form-hint">Email cannot be changed.</small>

          <label for="studentId">Student ID</label>
          <input type="text" id="studentId" readonly />
          <small class="form-hint">Student ID cannot be changed.</small>

          <label for="program">Program</label>
          <input type="text" id="program" name="program" />

          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" name="phone" pattern="[0-9+()\\s-]*" />

          <label for="bio">Short Bio</label>
          <textarea id="bio" name="bio" maxlength="500" rows="4"></textarea>
          <small class="form-hint">Maximum 500 characters</small>

          <button type="submit" class="btn-primary" style="margin-top: 15px">
            Save Changes
          </button>
        </form>
      </div>
    </main>

    <!-- JS -->
    <script src="js/api.js"></script>
    <script src="js/profilePage.js"></script>

    <script>
      // Menu toggle
      document.getElementById("dot").addEventListener("click", () => {
        document.getElementById("menu").classList.toggle("open");
      });

      // Logout logic
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logout-btn-student");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.removeItem("studentData");
            localStorage.removeItem("loggedInUser");
            window.location.href = "index.html";
          });
        }
      });
    
      // Populate form from backend or localStorage overrides, and handle submit
      document.addEventListener('DOMContentLoaded', () => {
        const API_BASE = 'http://127.0.0.1:5000';
        const getCookie = (name) => {
          const v = `; ${document.cookie}`;
          const p = v.split(`; ${name}=`);
          if (p.length === 2) return p.pop().split(';').shift();
          return null;
        };

        const getLS = (k) => { try { return localStorage.getItem(k); } catch(e){return null;} };
        const setLS = (k,v) => { try { localStorage.setItem(k,v); } catch(e){} };

        async function fetchUser() {
          const userId = getCookie('userId') || localStorage.getItem('userId');
          // try to use server data first
          if (userId) {
            try {
              let res = await fetch(`${API_BASE}/users/${encodeURIComponent(userId)}`);
              if (!res.ok) {
                // fallback to older endpoint
                res = await fetch(`${API_BASE}/api/student/me`);
              }
              if (res.ok) {
                return await res.json();
              }
            } catch (err) {
              console.warn('Could not fetch user from server:', err);
            }
          }

          // last-resort: try localStorage 'userData' or fields saved as overrides
          try {
            const raw = localStorage.getItem('userData');
            if (raw) return JSON.parse(raw);
          } catch(e) { /* ignore */ }

          // nothing found
          return null;
        }

        (async () => {
          const user = await fetchUser();

          // element references
          const elFirst = document.getElementById('firstName');
          const elLast = document.getElementById('lastName');
          const elEmail = document.getElementById('email');
          const elStudentId = document.getElementById('studentId');
          const elProgram = document.getElementById('program');
          const elPhone = document.getElementById('phone');
          const elBio = document.getElementById('bio');

          // Prefer server values; fall back to localStorage overrides when server value missing
          if (user) {
            try {
              if (elFirst) elFirst.value = user.first_name ?? getLS('profile_first_name') ?? '';
              if (elLast) elLast.value = user.last_name ?? getLS('profile_last_name') ?? '';
              if (elEmail) elEmail.value = user.email ?? getLS('profile_email') ?? '';
              if (elStudentId) elStudentId.value = user.student_id ?? user.id ?? getLS('profile_student_id') ?? '';
              if (elProgram) elProgram.value = user.program ?? getLS('profile_program') ?? '';
              if (elPhone) elPhone.value = user.phone ?? getLS('profile_phone') ?? '';
              if (elBio) elBio.value = user.bio ?? getLS('profile_bio') ?? '';
            } catch (e) { console.warn('Error populating form from user object', e); }
          } else {
            // No server user — populate from saved overrides if present
            const mappings = {
              firstName: 'profile_first_name',
              lastName: 'profile_last_name',
              program: 'profile_program',
              phone: 'profile_phone',
              bio: 'profile_bio'
            };
            Object.keys(mappings).forEach(id => {
              const el = document.getElementById(id);
              const val = getLS(mappings[id]);
              if (el && val) el.value = val;
            });
          }
        })();

        // now the submit handler (unchanged behavior)
        const form = document.getElementById('studentProfileForm');
        if (!form) return;
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const data = {
            first_name: document.getElementById('firstName').value.trim(),
            last_name: document.getElementById('lastName').value.trim(),
            program: document.getElementById('program').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            bio: document.getElementById('bio').value.trim()
          };

          if (!data.first_name || !data.last_name) {
            alert('Please provide both first and last name.');
            return;
          }

          // save to localStorage overrides
          setLS('profile_first_name', data.first_name);
          setLS('profile_last_name', data.last_name);
          setLS('profile_program', data.program);
          setLS('profile_phone', data.phone);
          setLS('profile_bio', data.bio);
          console.debug('Saved profile overrides to localStorage:', {
            first_name: localStorage.getItem('profile_first_name'),
            last_name: localStorage.getItem('profile_last_name'),
            program: localStorage.getItem('profile_program'),
            phone: localStorage.getItem('profile_phone'),
            bio: localStorage.getItem('profile_bio')
          });

          const userId = getCookie('userId') || localStorage.getItem('userId');
          if (userId) {
            try {
              await fetch(`http://127.0.0.1:5000/users/${encodeURIComponent(userId)}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
              });
            } catch (err) {
              console.warn('Backend update failed (ok to ignore if developing):', err);
            }
          }

          // redirect back to profile page where profilePage.js will read the overrides
          window.location.href = 'profilePage.html';
        });
      });
    </script>
  </body>
</html>
